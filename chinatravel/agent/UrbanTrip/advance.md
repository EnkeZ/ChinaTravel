# 我们可以尝试的改进点
## 偏好数据
UrbanTrip只考虑了hard_logic_py，没有考虑preference_py。

# UrbanTrip的改进
## 1.约束提取和解析的改进

引入了专门的约束解析方法 extract_user_constraints_by_DSL，提前筛选出最常用的约束，并使用这些约束进行搜索。

## 2.交通方式选择的改进

- NeSy Agent 和 LLM-Driven Agent使用固定的交通方式排序
- 引入了基于距离的交通方式选择

# 3.预算管理的改进

- NeSy Agent 和 LLM-Driven Agent预算检查主要在dfs搜索后期进行
- TPC Agent在搜索过程中实时检查预算，提前剪枝

# 4. POI选择策略的改进

- NeSy Agent 和 LLM-Driven Agent主要基于简单的启发式规则或LLM排序选择POI。
- TPC Agent实现了更复杂的POI选择策略，考虑约束满足.

# 6. 回溯机制的改进


# 1. generate_plan_with_search 函数
这是整个旅行规划的主入口函数，负责初始化搜索过程并进行高层级的搜索策略。

主要功能：

## 1.初始化阶段：

- 设置计时器和各种计数器（回溯次数、搜索节点数等）
- 初始化存储结构（正在访问的景点、餐厅等列表）
- 提取用户约束条件（景点偏好、餐厅偏好、预算限制等）
## 2.约束提取：

- 从查询中提取各种约束条件，包括：
    - 必须/禁止访问的景点和餐厅
    - 住宿偏好和限制
    - 时间约束（到达/离开时间）
    - 预算限制（各项花费预算）
    - 交通方式偏好
## 3.数据收集：

- 收集城际交通选项（火车、飞机）
- 收集酒店信息
- 根据用户约束对这些选项进行排序
## 4.搜索策略：

- 采用分层搜索策略，依次确定：
    - 去程交通方式
    - 返程交通方式
    - 住宿地点
- 对每种组合调用 dfs_poi 进行详细的逐日规划
## 5.回溯机制：

- 如果某个组合无法生成完整计划，则回溯尝试其他组合
- 设置时间限制，避免搜索时间过长

# 2. dfs_poi 函数
这是实际执行旅行计划生成的核心函数，使用深度优先搜索（DFS）和回溯算法来构建详细的逐日行程。

主要功能：

## 1.状态管理：

- 跟踪当前时间、位置和天数
- 管理已经访问的景点和餐厅，避免重复访问
## 2.决策逻辑：

- 根据当前状态决定下一步应该添加什么类型的活动：
    - 去程交通（第一天开始）
    - 早餐（每天开始）
    - 景点游览
    - 午餐/晚餐
    - 前往酒店住宿（非最后一天晚上）
    - 返程交通（最后一天）
## 3.约束检查：

- 时间约束：景点开放时间、活动时间窗口
- 预算约束：各项花费不能超出预算
- 用户偏好约束：必须/禁止访问的地点
- 交通约束：基于距离选择合适的交通方式
## 4.路径规划：

- 在不同地点间选择合适的市内交通方式
- 计算交通时间和费用
- 确保行程的时间连续性
## 5.回溯机制：

- 当某个选择导致后续无法满足约束时，撤销当前选择并尝试其他选项
- 维护回溯计数，控制搜索复杂度

# 执行流程
1. 初始化：generate_plan_with_search 初始化所有参数和约束
2. 高层搜索：确定城际交通和住宿的大致安排
3. 详细规划：对每种高层安排，调用 dfs_poi 进行逐日详细规划
4. 逐日决策：dfs_poi 根据当前状态决定添加哪种活动
5. 约束验证：在每一步都检查是否违反约束
6. 回溯处理：如果某步无法继续，则回溯到上一步尝试其他选项
7. 结果返回：找到满足所有约束的完整计划后返回
